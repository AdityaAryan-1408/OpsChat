generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               Int             @id @default(autoincrement())
  email            String          @unique
  password         String
  username         String?         @unique
  name             String?
  avatar           String?
  status           String?         // Short 1-line info (e.g. "DevOps Engineer")
  bio              String?         // Longer bio up to 500 chars
  createdAt        DateTime        @default(now())

  messages            Message[]
  workspaceMembers    WorkspaceMember[]
  createdChannels     Channel[]         @relation("CreatedChannels")
  channelMemberships  ChannelMember[]
  
  sentRequests     FriendRequest[] @relation("SentRequests")
  receivedRequests FriendRequest[] @relation("ReceivedRequests")
  
  sentDMs          DirectMessage[] @relation("SentDMs")
  receivedDMs      DirectMessage[] @relation("ReceivedDMs")
}

model FriendRequest {
  id         Int      @id @default(autoincrement())
  senderId   Int
  receiverId Int
  status     String   @default("PENDING") 
  createdAt  DateTime @default(now())

  sender     User     @relation("SentRequests", fields: [senderId], references: [id])
  receiver   User     @relation("ReceivedRequests", fields: [receiverId], references: [id])

  @@unique([senderId, receiverId])
}

model Workspace {
  id        Int               @id @default(autoincrement())
  name      String
  slug      String            @unique
  ownerId   Int
  createdAt DateTime          @default(now())

  channels  Channel[]
  members   WorkspaceMember[]
}

model WorkspaceMember {
  id          Int       @id @default(autoincrement())
  userId      Int
  workspaceId Int
  role        String    @default("MEMBER")
  joinedAt    DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id])
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([userId, workspaceId])
}

model Channel {
  id          Int             @id @default(autoincrement())
  name        String
  workspaceId Int
  creatorId   Int
  inviteCode  String          @unique @default(uuid())
  createdAt   DateTime        @default(now())

  workspace   Workspace       @relation(fields: [workspaceId], references: [id])
  creator     User            @relation("CreatedChannels", fields: [creatorId], references: [id])
  messages    Message[]
  members     ChannelMember[]

  @@unique([workspaceId, name])
}

model ChannelMember {
  id        Int      @id @default(autoincrement())
  userId    Int
  channelId Int
  role      String   @default("MEMBER") // CREATOR, ADMIN, MEMBER
  joinedAt  DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([userId, channelId])
}

model Message {
  id        Int       @id @default(autoincrement())
  content   String
  author    String
  userId    Int?
  type      String    @default("text")
  channelId Int
  expiresAt DateTime?
  createdAt DateTime  @default(now())

  channel   Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user      User?     @relation(fields: [userId], references: [id])
}

model DirectMessage {
  id         Int      @id @default(autoincrement())
  content    String
  type       String   @default("text")
  senderId   Int
  receiverId Int
  createdAt  DateTime @default(now())

  sender     User     @relation("SentDMs", fields: [senderId], references: [id])
  receiver   User     @relation("ReceivedDMs", fields: [receiverId], references: [id])
}